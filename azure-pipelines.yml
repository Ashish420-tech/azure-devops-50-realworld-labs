trigger:
  branches:
    include:
      - main

variables:
  IMAGE_TAG: $(Build.BuildId)

pool:
  name: Default
  demands:
    - Agent.Name -equals wsl-agent

stages:
- stage: CI
  displayName: CI - Update GitOps Repo
  jobs:
  - job: UpdateGitOps
    displayName: Update GitOps Manifest
    steps:

    # Checkout repository with credentials (required for push)
    - checkout: self
      persistCredentials: true

    # FIX: Fetch and checkout main branch correctly (NO detached HEAD)
    - script: |
        echo "Fetching remote branches"
        git fetch origin

        echo "Checking out main branch from origin"
        git checkout -B main origin/main
      displayName: Checkout main branch safely

    # Update image tag in GitOps manifest
    - script: |
        echo "Updating image tag in GitOps manifest"
        sed -i "s|image: nginx:.*|image: nginx:${IMAGE_TAG}|g" lab-30-argocd-gitops/deployment.yaml
      displayName: Update image tag in deployment.yaml

    # Commit and push GitOps change
    - script: |
        git config user.email "ci@azuredevops.com"
        git config user.name "Azure DevOps CI"

        git add lab-30-argocd-gitops/deployment.yaml

        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "CI: update image tag to ${IMAGE_TAG}"
          git push origin main
        fi
      displayName: Commit GitOps update
