trigger:
  branches:
    include:
      - main

variables:
  IMAGE_TAG: $(Build.BuildId)

stages:
- stage: CI
  displayName: Build and Update GitOps
  jobs:
  - job: UpdateGitOps
    displayName: Update GitOps Manifest
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self
      persistCredentials: true

    - script: |
        echo "Updating image tag in GitOps manifest"
        sed -i "s|image: nginx:.*|image: nginx:${IMAGE_TAG}|g" lab-30-argocd-gitops/deployment.yaml
      displayName: Update image tag

    - script: |
        git config user.email "ci@azuredevops.com"
        git config user.name "Azure DevOps CI"
        git add lab-30-argocd-gitops/deployment.yaml
        git commit -m "CI: update image tag to ${IMAGE_TAG}"
        git push origin main
      displayName: Commit GitOps update
