
trigger:
- main

pool:
  name: Default   # self-hosted Windows agent

steps:
- checkout: self

- script: |
    echo === Verify Kubernetes ===
    kubectl config current-context
    kubectl get nodes
  displayName: "Verify Minikube Access"

- script: |
    cd 03-nodejs/lab-14-kubernetes-deploy/app
    docker build -t lab14-nodejs:latest .
  displayName: "Build Docker Image"

- script: |
    echo === Load image into Minikube ===
    minikube image load lab14-nodejs:latest
  displayName: "Load Image into Minikube"

- script: |
    kubectl apply -f 03-nodejs/lab-14-kubernetes-deploy/k8s/deployment.yml
    kubectl apply -f 03-nodejs/lab-14-kubernetes-deploy/k8s/service.yml
    kubectl rollout restart deployment lab14-nodejs-deployment
    kubectl rollout status deployment lab14-nodejs-deployment
  displayName: "Deploy to Minikube"


