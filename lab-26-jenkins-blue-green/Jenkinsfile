pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "ashishmondal420/lab23-jenkins-cicd:latest"
        KUBECTL = "/usr/local/bin/kubectl"
        K8S_DIR = "lab-26-jenkins-blue-green/k8s"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build & Push Image') {
            steps {
                withCredentials([string(credentialsId: 'dockerhub-creds', variable: 'DOCKER_PASS')]) {
                    sh '''
                        docker build -t ${DOCKER_IMAGE} \
                          -f lab-23-jenkins-docker-build/Dockerfile \
                          lab-23-jenkins-docker-build

                        echo "$DOCKER_PASS" | docker login -u ashishmondal420 --password-stdin
                        docker push ${DOCKER_IMAGE}
                    '''
                }
            }
        }

        stage('Deploy GREEN Version') {
            steps {
                sh '''
                    sudo -u ashish ${KUBECTL} apply -f ${K8S_DIR}/deployment-green.yaml
                '''
            }
        }

        stage('Smoke Test GREEN') {
            steps {
                sh '''
                    sleep 10
                    sudo -u ashish ${KUBECTL} get pods -l version=green
                '''
            }
        }

        stage('Switch Traffic to GREEN') {
            steps {
                sh '''
                    sudo -u ashish ${KUBECTL} patch svc myapp-service \
                      -p '{"spec":{"selector":{"app":"myapp","version":"green"}}}'
                '''
            }
        }
    }

    post {
        failure {
            echo "❌ Deployment failed — rolling back to BLUE"

            sh '''
                sudo -u ashish ${KUBECTL} patch svc myapp-service \
                  -p '{"spec":{"selector":{"app":"myapp","version":"blue"}}}'
            '''
        }

        success {
            echo "✅ Blue-Green deployment completed successfully"
        }
    }
}
